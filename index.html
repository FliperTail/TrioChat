<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>TrioChat-demo</title>
<style>
body { font-family: Arial, sans-serif; margin:0; padding:0; background:#f0f0f0; display:flex; justify-content:center; align-items:center; height:100vh; }
#username-page, #chat-page { display:none; width:100%; max-width:700px; flex-direction:column; align-items:center; }
#username-page input { padding:10px; font-size:16px; }
#username-page button { margin-left:10px; padding:10px 20px; font-size:16px; border:none; background:#007bff; color:white; border-radius:5px; cursor:pointer; }
#error { color:red; margin-top:10px; text-align:center; }
h2 { text-align:center; background:#007bff; color:white; padding:10px 20px; margin:10px 0; border-radius:5px; display:inline-block; }
#room-select { text-align:center; margin:10px 0; }
#room-select button { margin:0 5px; padding:5px 10px; cursor:pointer; border:none; border-radius:5px; background:#ccc; color:black; }
#room-select button.active { background:#007bff; color:white; }
.chat-container { display:flex; width:100%; height:500px; background:#fff; border:1px solid #ccc; border-radius:5px; overflow:hidden; }
#user-list { width:150px; border-right:1px solid #ccc; background:#f9f9f9; padding:10px; overflow-y:auto; }
#user-list h4 { margin-top:0; }
#chat-area { flex:1; display:flex; flex-direction:column; }
#chat-box { flex:1; padding:10px; overflow-y:auto; background:#f9f9f9; }
.msg { margin:5px 0; padding:8px 12px; background:#e1f5fe; border-radius:5px; }
#message-form { display:flex; padding:10px; border-top:1px solid #ccc; background:#eee; }
#message-input { flex:1; padding:10px; border:1px solid #ccc; border-radius:5px; }
button.send-btn { margin-left:10px; padding:10px 20px; border:none; background:#007bff; color:white; border-radius:5px; cursor:pointer; }
button.send-btn:disabled { background:#999; cursor:not-allowed; }
.user-item { padding:4px 6px; border-bottom:1px solid #ddd; }
</style>
</head>
<body>

<div id="username-page">
  <h2>Enter a username</h2>
  <input type="text" id="username-input" placeholder="Username" />
  <button id="submit-username">Enter Chat</button>
  <div id="error"></div>
</div>

<div id="chat-page">
  <h2>TrioChat</h2>
  <div id="room-select">
    <button class="room-btn" data-room="Room 1">Room 1</button>
    <button class="room-btn" data-room="Room 2">Room 2</button>
    <button class="room-btn" data-room="Room 3">Room 3</button>
    <button id="create-room-btn" style="background:#28a745;color:white;">+ Create Room</button>
  </div>

  <div class="chat-container">
    <div id="user-list">
      <h4>Online Users</h4>
      <div id="users"></div>
    </div>
    <div id="chat-area">
      <div id="chat-box"></div>
      <form id="message-form">
        <input type="text" id="message-input" placeholder="Type a message..." required />
        <button class="send-btn" type="submit">Send</button>
      </form>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
import { getFirestore, collection, doc, getDoc, setDoc, addDoc, serverTimestamp, query, orderBy, onSnapshot, getDocs, deleteDoc } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCH3EXgZ9FN_t_tEW10uR5YmHiX_pabzew",
  authDomain: "triochat-cbd25.firebaseapp.com",
  projectId: "triochat-cbd25",
  storageBucket: "triochat-cbd25.firebasestorage.app",
  messagingSenderId: "240591787712",
  appId: "1:240591787712:web:7486c19c654a173eb4bf25",
  measurementId: "G-TFXZ6HSSHN"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// DOM Elements
const usernamePage = document.getElementById("username-page");
const chatPage = document.getElementById("chat-page");
const usernameInput = document.getElementById("username-input");
const submitUsername = document.getElementById("submit-username");
const errorDiv = document.getElementById("error");
const chatBox = document.getElementById('chat-box');
const messageForm = document.getElementById('message-form');
const messageInput = document.getElementById('message-input');
const sendButton = document.querySelector(".send-btn");
const roomButtonsContainer = document.getElementById("room-select");
let roomButtons = document.querySelectorAll(".room-btn");
const usersDiv = document.getElementById("users");

// State
let username = "";
let currentRoom = "Room 1";
let unsubscribe = null;

// --- Helper: Update online users ---
function updateOnlineUsers() {
  const onlineRef = collection(db, "onlineUsers");

  // Start updating user's lastSeen every 5 seconds
  setInterval(() => {
    setDoc(doc(db,"onlineUsers",username), { username, lastSeen: serverTimestamp() }, { merge: true });
  }, 5000);

  // Listen for all users
  onSnapshot(onlineRef, snapshot => {
    usersDiv.innerHTML = "";
    const now = Date.now();
    snapshot.forEach(doc => {
      const data = doc.data();
      if (data.lastSeen && data.lastSeen.toMillis() + 10000 > now) { // only show if lastSeen < 10s
        const userItem = document.createElement("div");
        userItem.classList.add("user-item");
        userItem.textContent = data.username;
        usersDiv.appendChild(userItem);
      }
    });
  });
}

// --- Username check / login ---
usernamePage.style.display = "flex";
const savedUsername = localStorage.getItem("triochat_username");
if (savedUsername) {
  const usernameDoc = doc(db, "usernames", savedUsername);
  getDoc(usernameDoc).then(docSnap => {
    if (docSnap.exists()) {
      username = savedUsername;
      loginUser();
    } else {
      localStorage.removeItem("triochat_username");
    }
  });
}

submitUsername.addEventListener("click", async () => {
  const name = usernameInput.value.trim();
  if (!name) return;
  const usernameDoc = doc(db, "usernames", name);
  const docSnap = await getDoc(usernameDoc);
  if (docSnap.exists()) {
    errorDiv.textContent = "Username is already taken.";
  } else {
    await setDoc(usernameDoc, { created: serverTimestamp() });
    username = name;
    localStorage.setItem("triochat_username", username);
    loginUser();
  }
});

function loginUser() {
  usernamePage.style.display = "none";
  chatPage.style.display = "flex";
  // Add user to online users
  setDoc(doc(db,"onlineUsers",username), { username });
  updateOnlineUsers();
  loadRooms();
}

// Remove user from online list when leaving
window.addEventListener("beforeunload", async () => {
  await deleteDoc(doc(db,"onlineUsers",username));
});

// --- Rooms ---
async function loadRooms() {
  const roomSnap = await getDocs(collection(db, "rooms"));
  roomButtonsContainer.querySelectorAll('.room-btn').forEach(btn=>{
    if(!["Room 1","Room 2","Room 3"].includes(btn.dataset.room)) btn.remove();
  });
  roomSnap.forEach(doc => {
    const data = doc.data();
    if (data.private && !data.allowedUsers.includes(username)) return;
    addRoomButton(doc.id);
  });
  addRoomListeners();
  setActiveRoomButton();
  startChat(currentRoom);
}

function addRoomButton(name) {
  if (document.querySelector(`.room-btn[data-room='${name}']`)) return;
  const btn = document.createElement("button");
  btn.classList.add("room-btn");
  btn.dataset.room = name;
  btn.textContent = name;
  roomButtonsContainer.insertBefore(btn, document.getElementById("create-room-btn"));
}

function addRoomListeners() {
  roomButtons = document.querySelectorAll(".room-btn");
  roomButtons.forEach(btn => {
    btn.onclick = () => {
      const selectedRoom = btn.dataset.room;
      if (selectedRoom === currentRoom) return;
      currentRoom = selectedRoom;
      setActiveRoomButton();
      startChat(currentRoom);
    }
  });
}

function setActiveRoomButton() {
  roomButtons.forEach(btn => {
    btn.classList.toggle("active", btn.dataset.room === currentRoom);
  });
}

// Create private room
document.getElementById("create-room-btn").addEventListener("click", async () => {
  const roomName = prompt("Enter a name for your private room:");
  if (!roomName) return;
  const allowedUsersInput = prompt("Enter usernames allowed (comma-separated):");
  const allowedUsers = allowedUsersInput ? allowedUsersInput.split(",").map(u=>u.trim()) : [];
  if (!allowedUsers.includes(username)) allowedUsers.push(username);

  await setDoc(doc(db,"rooms",roomName), { private:true, allowedUsers });
  addRoomButton(roomName);
  addRoomListeners();
});

// --- Chat listener ---
function startChat(room) {
  chatBox.innerHTML = "";
  if (unsubscribe) unsubscribe();
  const q = query(collection(db, "messages"), orderBy("timestamp"));
  unsubscribe = onSnapshot(q, snapshot => {
    chatBox.innerHTML = "";
    snapshot.forEach(doc => {
      const data = doc.data();
      if (data.room !== room) return;
      const msg = document.createElement("div");
      msg.classList.add("msg");
      msg.textContent = `${data.username}: ${data.text}`;
      chatBox.appendChild(msg);
    });
    chatBox.scrollTop = chatBox.scrollHeight;
  });
}

// --- Send message ---
messageForm.addEventListener("submit", async e => {
  e.preventDefault();
  const text = messageInput.value.trim();
  if (!text) return;
  messageInput.value = "";
  sendButton.disabled = true;
  setTimeout(()=>sendButton.disabled=false,500);
  await addDoc(collection(db,"messages"),{ username, text, room:currentRoom, timestamp:serverTimestamp() });
});
</script>

</body>
</html>

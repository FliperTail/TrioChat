<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>TrioChat-demo</title>
<style>
body {
  font-family: Arial, sans-serif;
  margin: 0;
  padding: 0;
  height: 100vh;
}

/* Pages */
#username-page, #chat-page {
  display: none;
  height: 100vh;
  flex-direction: column;
  justify-content: center;
  align-items: center;
}

/* Username page */
#username-page input { padding:10px; font-size:16px; }
#username-page button { margin-left:10px; padding:10px 20px; font-size:16px; border:none; background:#007bff; color:white; border-radius:5px; cursor:pointer; }
#error { color:red; margin-top:10px; }

/* Header */
h2 {
  text-align: center;
  background: #007bff;
  color: white;
  padding: 10px;
  margin: 0;
}

/* Room buttons */
#room-select {
  text-align: center;
  margin: 10px 0;
}
#room-select button {
  margin: 0 5px;
  padding: 5px 10px;
  cursor: pointer;
  border: none;
  border-radius: 5px;
  background: #ccc;
  color: black;
}
#room-select button.active {
  background: #007bff;
  color: white;
}

/* Chat container */
.chat-container {
  max-width: 600px;
  width: 100%;
  border: 1px solid #ccc;
  border-radius: 5px;
  background: #fff;
  display: flex;
  flex-direction: column;
  overflow: hidden;
  margin: 0 auto;
}

/* Chat messages */
#chat-box {
  height: 400px;
  padding: 10px;
  overflow-y: auto;
  background: #f9f9f9;
  flex: 1;
}

/* Individual messages */
.msg {
  margin: 5px 0;
  padding: 8px 12px;
  background: #e1f5fe;
  border-radius: 5px;
}

/* Input area */
#message-form {
  display: flex;
  padding: 10px;
  border-top: 1px solid #ccc;
  background: #eee;
}
#message-input {
  flex: 1;
  padding: 10px;
  border: 1px solid #ccc;
  border-radius: 5px;
}
button.send-btn {
  margin-left: 10px;
  padding: 10px 20px;
  border: none;
  background: #007bff;
  color: white;
  border-radius: 5px;
  cursor: pointer;
}
</style>
</head>
<body>

<!-- Username page -->
<div id="username-page">
  <h2>Enter a username</h2>
  <input type="text" id="username-input" placeholder="Username" />
  <button id="submit-username">Enter Chat</button>
  <div id="error"></div>
</div>

<!-- Chat page -->
<div id="chat-page">
  <h2>TrioChat</h2>
  <div id="room-select">
    <button class="room-btn" data-room="Room 1">Room 1</button>
    <button class="room-btn" data-room="Room 2">Room 2</button>
    <button class="room-btn" data-room="Room 3">Room 3</button>
  </div>

  <!-- Chat container -->
  <div class="chat-container">
    <div id="chat-box"></div>
    <form id="message-form">
      <input type="text" id="message-input" placeholder="Type a message..." required />
      <button class="send-btn" type="submit">Send</button>
    </form>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
import { getFirestore, collection, doc, getDoc, setDoc, addDoc, serverTimestamp, query, orderBy, onSnapshot } 
from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCH3EXgZ9FN_t_tEW10uR5YmHiX_pabzew",
  authDomain: "triochat-cbd25.firebaseapp.com",
  projectId: "triochat-cbd25",
  storageBucket: "triochat-cbd25.firebasestorage.app",
  messagingSenderId: "240591787712",
  appId: "1:240591787712:web:7486c19c654a173eb4bf25",
  measurementId: "G-TFXZ6HSSHN"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const usernamePage = document.getElementById("username-page");
const chatPage = document.getElementById("chat-page");
const usernameInput = document.getElementById("username-input");
const submitUsername = document.getElementById("submit-username");
const errorDiv = document.getElementById("error");

const chatBox = document.getElementById('chat-box');
const messageForm = document.getElementById('message-form');
const messageInput = document.getElementById('message-input');
const roomButtons = document.querySelectorAll(".room-btn");

let username = "";
let currentRoom = "Room 1";
let unsubscribe = null;

usernamePage.style.display = "flex";

// Check if username is saved
const savedUsername = localStorage.getItem("triochat_username");
if (savedUsername) {
  const usernameDoc = doc(db, "usernames", savedUsername);
  getDoc(usernameDoc).then(docSnap => {
    if (docSnap.exists()) {
      username = savedUsername;
      usernamePage.style.display = "none";
      chatPage.style.display = "flex";
      setActiveRoomButton();
      startChat(currentRoom);
    } else {
      localStorage.removeItem("triochat_username");
    }
  });
}

submitUsername.addEventListener("click", async () => {
  const name = usernameInput.value.trim();
  if (!name) return;

  const usernameDoc = doc(db, "usernames", name);
  const docSnap = await getDoc(usernameDoc);

  if (docSnap.exists()) {
    errorDiv.textContent = "Username is already taken.";
  } else {
    await setDoc(usernameDoc, { created: serverTimestamp() });
    username = name;
    localStorage.setItem("triochat_username", username);
    usernamePage.style.display = "none";
    chatPage.style.display = "flex";
    setActiveRoomButton();
    startChat(currentRoom);
  }
});

// Room switching
roomButtons.forEach(btn => {
  btn.addEventListener("click", () => {
    const selectedRoom = btn.dataset.room;
    if (selectedRoom === currentRoom) return;
    currentRoom = selectedRoom;
    setActiveRoomButton();
    if (unsubscribe) unsubscribe();
    startChat(currentRoom);
  });
});

// Highlight active room
function setActiveRoomButton() {
  roomButtons.forEach(btn => {
    btn.classList.toggle("active", btn.dataset.room === currentRoom);
  });
}

function startChat(room) {
  chatBox.innerHTML = "";
  const q = query(collection(db, "messages"), orderBy("timestamp"));

  if (unsubscribe) unsubscribe();

  unsubscribe = onSnapshot(q, snapshot => {
    chatBox.innerHTML = "";
    snapshot.forEach(doc => {
      const data = doc.data();
      if (data.room === room) {
        const msg = document.createElement("div");
        msg.classList.add("msg");
        msg.textContent = `${data.username}: ${data.text}`;
        chatBox.appendChild(msg);
      }
    });

    // Scroll chat box
    chatBox.scrollTop = chatBox.scrollHeight;
  });
}

messageForm.addEventListener("submit", async e => {
  e.preventDefault();
  const text = messageInput.value.trim();
  if (text) {
    await addDoc(collection(db, "messages"), {
      username,
      text,
      room: currentRoom,
      timestamp: serverTimestamp()
    });
    messageInput.value = "";
  }
});
</script>

</body>
</html>

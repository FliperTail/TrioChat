<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>TrioChat-demo</title>
<style>
body { font-family: Arial, sans-serif; margin:0; padding:0; background:#f0f0f0; display:flex; justify-content:center; align-items:center; height:100vh; }
#username-page, #chat-page { display:none; width:100%; max-width:700px; flex-direction:column; align-items:center; }
#username-page input { padding:10px; font-size:16px; }
#username-page button { margin-left:10px; padding:10px 20px; font-size:16px; border:none; background:#007bff; color:white; border-radius:5px; cursor:pointer; }
#error { color:red; margin-top:10px; text-align:center; }
h2 { text-align:center; background:#007bff; color:white; padding:10px 20px; margin:10px 0; border-radius:5px; display:inline-block; }
#room-select { text-align:center; margin:10px 0; }
#room-select button { margin:0 5px; padding:5px 10px; cursor:pointer; border:none; border-radius:5px; background:#ccc; color:black; }
#room-select button.active { background:#007bff; color:white; }
.chat-container { display:flex; width:100%; height:500px; background:#fff; border:1px solid #ccc; border-radius:5px; overflow:hidden; }
#user-list { width:200px; border-right:1px solid #ccc; background:#f9f9f9; padding:10px; overflow-y:auto; }
#user-list h4 { margin-top:0; }
#chat-area { flex:1; display:flex; flex-direction:column; }
#chat-box { flex:1; padding:10px; overflow-y:auto; background:#f9f9f9; }
.msg { margin:5px 0; padding:8px 12px; background:#e1f5fe; border-radius:5px; }
#message-form { display:flex; padding:10px; border-top:1px solid #ccc; background:#eee; }
#message-input { flex:1; padding:10px; border:1px solid #ccc; border-radius:5px; }
button.send-btn { margin-left:10px; padding:10px 20px; border:none; background:#007bff; color:white; border-radius:5px; cursor:pointer; }
button.send-btn:disabled { background:#999; cursor:not-allowed; }
.user-item { padding:4px 6px; border-bottom:1px solid #ddd; }
.user-name { font-weight:bold; }
.user-buttons { margin-top:4px; display:flex; gap:4px; }
.user-buttons button { flex:1; font-size:11px; padding:3px; border:none; border-radius:3px; cursor:pointer; }
.block-btn { background:#dc3545; color:white; }
.dm-btn { background:#28a745; color:white; }

/* DM modal */
#dm-modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); justify-content:center; align-items:center; }
#dm-modal .modal-content { background:#fff; padding:20px; border-radius:5px; width:300px; text-align:center; }
#dm-modal input { width:80%; padding:8px; margin-bottom:10px; }
#dm-modal button { padding:8px 12px; margin:0 5px; }

/* My Status box */
#my-status { margin-top:15px; padding-top:10px; border-top:1px solid #ccc; }
#my-status h4 { margin:0 0 5px; }
#my-username { font-weight:bold; margin-bottom:5px; }
.status-buttons { display:flex; gap:5px; margin-top:5px; }
.status-buttons button { flex:1; font-size:12px; padding:4px; border:none; border-radius:4px; cursor:pointer; }
#online-btn { background:#28a745; color:white; }
#dnd-btn { background:#ffc107; color:black; }
</style>
</head>
<body>

<div id="username-page">
  <h2>Enter a username</h2>
  <input type="text" id="username-input" placeholder="Username" />
  <button id="submit-username">Enter Chat</button>
  <div id="error"></div>
</div>

<div id="chat-page">
  <h2>TrioChat</h2>
  <div id="room-select">
    <button class="room-btn" data-room="Room 1">Room 1</button>
    <button class="room-btn" data-room="Room 2">Room 2</button>
    <button class="room-btn" data-room="Room 3">Room 3</button>
    <button id="create-room-btn" style="background:#28a745;color:white;">+ Create Room</button>
  </div>

  <div class="chat-container">
    <div id="user-list">
      <h4>Online Users</h4>
      <div id="users"></div>

      <!-- My Status -->
      <div id="my-status">
        <h4>My Status</h4>
        <div id="my-username"></div>
        <div class="status-buttons">
          <button id="online-btn">Online</button>
          <button id="dnd-btn">Do Not Disturb</button>
        </div>
      </div>
    </div>
    <div id="chat-area">
      <div id="chat-box"></div>
      <form id="message-form">
        <input type="text" id="message-input" placeholder="Type a message!.." required />
        <button class="send-btn" type="submit">Send</button>
      </form>
    </div>
  </div>
</div>

<!-- DM Modal -->
<div id="dm-modal">
  <div class="modal-content">
    <h3>Send DM</h3>
    <input type="text" id="dm-username" placeholder="Username" />
    <div>
      <button id="dm-send-btn">Open DM</button>
      <button id="dm-cancel-btn">Cancel</button>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
import { getFirestore, collection, doc, getDoc, setDoc, addDoc, serverTimestamp, query, orderBy, onSnapshot, deleteDoc } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCH3EXgZ9FN_t_tEW10uR5YmHiX_pabzew",
  authDomain: "triochat-cbd25.firebaseapp.com",
  projectId: "triochat-cbd25",
  storageBucket: "triochat-cbd25.appspot.com",
  messagingSenderId: "240591787712",
  appId: "1:240591787712:web:7486c19c654a173eb4bf25",
  measurementId: "G-TFXZ6HSSHN"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// DOM
const usernamePage = document.getElementById("username-page");
const chatPage = document.getElementById("chat-page");
const usernameInput = document.getElementById("username-input");
const submitUsername = document.getElementById("submit-username");
const errorDiv = document.getElementById("error");
const chatBox = document.getElementById('chat-box');
const messageForm = document.getElementById('message-form');
const messageInput = document.getElementById('message-input');
const sendButton = document.querySelector(".send-btn");
const roomButtonsContainer = document.getElementById("room-select");
let roomButtons = document.querySelectorAll(".room-btn");
const usersDiv = document.getElementById("users");

const dmModal = document.getElementById("dm-modal");
const dmUsernameInput = document.getElementById("dm-username");
const dmSendBtn = document.getElementById("dm-send-btn");
const dmCancelBtn = document.getElementById("dm-cancel-btn");

const myUsernameDiv = document.getElementById("my-username");
const onlineBtn = document.getElementById("online-btn");
const dndBtn = document.getElementById("dnd-btn");

let username = "";
let userStatus = "online"; // default
let currentRoom = "Room 1";
let unsubscribeMessages = null;
let blockedUsers = JSON.parse(localStorage.getItem("blockedUsers") || "[]");
const onlineUsersMap = new Map();
let unsubscribeRooms = null;

// --- Update Online Users ---
function updateOnlineUsers() {
  const onlineRef = collection(db,"onlineUsers");

  // heartbeat every 5s
  setInterval(() => {
    setDoc(
      doc(db,"onlineUsers",username),
      { username, lastSeen: serverTimestamp(), status:userStatus },
      { merge:true }
    );
  }, 5000);

  // live update
  onSnapshot(onlineRef, snapshot => {
    const now = Date.now();
    usersDiv.innerHTML = "";
    onlineUsersMap.clear();

    snapshot.forEach(docSnap => {
      const data = docSnap.data();
      const lastSeen = data.lastSeen?.toMillis() || 0;
      if (lastSeen + 10000 <= now || data.username === username) return;

      const userItem = document.createElement("div");
      userItem.classList.add("user-item");

      const statusLabel = data.status === "dnd" ? " (DND)" : "";
      userItem.innerHTML = `<div class="user-name">${data.username}${statusLabel}</div>`;

      const btns = document.createElement("div");
      btns.classList.add("user-buttons");

      const blockBtn = document.createElement("button");
      blockBtn.textContent = blockedUsers.includes(data.username) ? "Unignore" : "Ignore";
      blockBtn.className = "block-btn";
      blockBtn.onclick = ()=>toggleBlock(data.username, blockBtn);

      const dmBtn = document.createElement("button");
      dmBtn.textContent = "DM";
      dmBtn.className = "dm-btn";
      dmBtn.onclick = ()=>openDMModal(data.username);

      btns.appendChild(blockBtn);
      btns.appendChild(dmBtn);
      userItem.appendChild(btns);

      usersDiv.appendChild(userItem);
      onlineUsersMap.set(data.username, userItem);
    });
  });
}

// --- Status Buttons ---
onlineBtn.onclick = () => {
  userStatus = "online";
  myUsernameDiv.textContent = `${username} (Online)`;
  setDoc(doc(db,"onlineUsers",username), { status:userStatus }, { merge:true });
};
dndBtn.onclick = () => {
  userStatus = "dnd";
  myUsernameDiv.textContent = `${username} (DND)`;
  setDoc(doc(db,"onlineUsers",username), { status:userStatus }, { merge:true });
};

// --- Block/unblock ---
function toggleBlock(name, btn) {
  if (blockedUsers.includes(name)) {
    blockedUsers = blockedUsers.filter(n=>n!==name);
    btn.textContent = "Ignore";
  } else {
    blockedUsers.push(name);
    btn.textContent = "Unignore";
  }
  localStorage.setItem("blockedUsers", JSON.stringify(blockedUsers));
  refreshMessages();
}

// --- DM Modal ---
function openDMModal(user) {
  dmUsernameInput.value = user;
  dmModal.style.display = "flex";
}
dmSendBtn.onclick = async ()=>{
  const otherUser = dmUsernameInput.value.trim();
  if (!otherUser) return;
  const roomName = [username, otherUser].sort().join("_DM_");
  await setDoc(doc(db,"rooms",roomName), { private:true, allowedUsers:[username, otherUser] });
  currentRoom = roomName;
  setActiveRoomButton();
  startChat(roomName);
  dmModal.style.display = "none";
  loadRoomsRealtime();
}
dmCancelBtn.onclick = ()=>dmModal.style.display="none";

// --- Username/Login ---
usernamePage.style.display="flex";
const savedUsername = localStorage.getItem("triochat_username");
if (savedUsername) checkLogin(savedUsername);

submitUsername.addEventListener("click", async ()=>{
  const name = usernameInput.value.trim();
  if(!name) return;
  const usernameDoc = doc(db,"usernames",name);
  const docSnap = await getDoc(usernameDoc);
  if(docSnap.exists()){
    errorDiv.textContent="Username is already taken.";
  } else {
    await setDoc(usernameDoc,{created:serverTimestamp()});
    localStorage.setItem("triochat_username",name);
    checkLogin(name);
  }
});

function checkLogin(name){
  username = name;
  usernamePage.style.display="none";
  chatPage.style.display="flex";
  myUsernameDiv.textContent = `${username} (Online)`; // default
  setDoc(doc(db,"onlineUsers",username), { username, lastSeen:serverTimestamp(), status:userStatus });
  updateOnlineUsers();
  loadRoomsRealtime();
  startChat(currentRoom);
}

// Remove self on exit
window.addEventListener("beforeunload", async ()=> {
  await deleteDoc(doc(db,"onlineUsers",username));
});

// --- Rooms real-time ---
function loadRoomsRealtime() {
  const roomsRef = collection(db,"rooms");
  if(unsubscribeRooms) unsubscribeRooms();
  unsubscribeRooms = onSnapshot(roomsRef, snapshot => {
    roomButtonsContainer.querySelectorAll('.room-btn').forEach(btn=>{
      if(!["Room 1","Room 2","Room 3"].includes(btn.dataset.room)) btn.remove();
    });
    snapshot.forEach(docSnap=>{
      const data = docSnap.data();
      if(data.private && !data.allowedUsers.includes(username)) return;
      addRoomButton(docSnap.id);
    });
    addRoomListeners();
    setActiveRoomButton();
    startChat(currentRoom);
  });
}

function addRoomButton(name){
  if(document.querySelector(`.room-btn[data-room='${name}']`)) return;
  const btn=document.createElement("button");
  btn.classList.add("room-btn");
  btn.dataset.room=name;
  btn.textContent=name;
  roomButtonsContainer.insertBefore(btn, document.getElementById("create-room-btn"));
}
function addRoomListeners(){
  roomButtons = document.querySelectorAll(".room-btn");
  roomButtons.forEach(btn=>{
    btn.onclick = ()=>{
      const selectedRoom = btn.dataset.room;
      if(selectedRoom===currentRoom) return;
      currentRoom=selectedRoom;
      setActiveRoomButton();
      startChat(currentRoom);
    };
  });
}
function setActiveRoomButton(){
  roomButtons.forEach(btn=>{
    btn.classList.toggle("active", btn.dataset.room===currentRoom);
  });
}

// --- Create private room manually ---
document.getElementById("create-room-btn").addEventListener("click", async ()=>{
  const roomName = prompt("Enter a name for your private room:");
  if(!roomName) return;
  const allowedUsersInput = prompt("Enter usernames allowed (comma-separated):");
  const allowedUsers = allowedUsersInput ? allowedUsersInput.split(",").map(u=>u.trim()) : [];
  if(!allowedUsers.includes(username)) allowedUsers.push(username);
  await setDoc(doc(db,"rooms",roomName), { private:true, allowedUsers });
  loadRoomsRealtime();
});

// --- Chat ---
let cachedMessages = [];
async function startChat(room){
  chatBox.innerHTML="";
  cachedMessages=[];
  if(unsubscribeMessages) unsubscribeMessages();

  const roomRef = doc(db,"rooms",room);
  const rSnap = await getDoc(roomRef);
  const roomData = rSnap.exists()? rSnap.data(): { private:false };
  const allowed = !roomData.private || roomData.allowedUsers.includes(username);
  if(!allowed){ chatBox.innerHTML="<div class='msg'>You don't have access to this room.</div>"; return; }

  const q = query(collection(db,"messages"), orderBy("timestamp"));
  unsubscribeMessages = onSnapshot(q, snapshot=>{
    snapshot.docChanges().forEach(change=>{
      const data = change.doc.data();
      if(data.room!==room) return;
      if(change.type==="added") cachedMessages.push({id:change.doc.id,...data});
      if(change.type==="modified") cachedMessages = cachedMessages.map(m=>m.id===change.doc.id?{id:change.doc.id,...data}:m);
      if(change.type==="removed") cachedMessages = cachedMessages.filter(m=>m.id!==change.doc.id);
    });
    refreshMessages();
  });
}

function refreshMessages(){
  chatBox.innerHTML="";
  cachedMessages.forEach(data=>{
    if(blockedUsers.includes(data.username)) return;
    const msg = document.createElement("div");
    msg.classList.add("msg");
    msg.textContent=`${data.username}: ${data.text}`;
    chatBox.appendChild(msg);
  });
  chatBox.scrollTop = chatBox.scrollHeight;
}

// --- Send ---
messageForm.addEventListener("submit", async e=>{
  e.preventDefault();
  const text = messageInput.value.trim();
  if(!text) return;
  messageInput.value="";
  sendButton.disabled=true;
  setTimeout(()=>sendButton.disabled=false,500);
  await addDoc(collection(db,"messages"), { username, text, room:currentRoom, timestamp:serverTimestamp() });
});
</script>

</body>
</html>
